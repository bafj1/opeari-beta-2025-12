subject: 'You\'re in üéâ Your Opeari access is ready'
const { createClient } = require('@supabase/supabase-js')
const { Resend } = require('resend')

exports.handler = async (event) => {
    // 1. Headers & Method Check
    const headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type, x-admin-secret',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Content-Type': 'application/json'
    }

    if (event.httpMethod === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' }
    }

    if (event.httpMethod !== 'POST') {
        return { statusCode: 405, headers, body: 'Method not allowed' }
    }

    // 2. Security Check (Admin Secret)
    const secret = event.headers['x-admin-secret'] || event.headers['X-Admin-Secret']
    if (secret !== process.env.NETLIFY_ADMIN_SECRET) {
        return { statusCode: 401, headers, body: JSON.stringify({ error: 'Unauthorized' }) }
    }

    // 3. Env Check
    const supabaseUrl = process.env.SUPABASE_URL
    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY
    const resendApiKey = process.env.RESEND_API_KEY
    const siteUrl = process.env.URL || 'https://opeari.com'

    if (!supabaseUrl || !supabaseServiceKey || !resendApiKey) {
        console.error('Missing Env Vars')
        return { statusCode: 500, headers, body: JSON.stringify({ error: 'Configuration Error' }) }
    }

    try {
        const supabase = createClient(supabaseUrl, supabaseServiceKey)
        const resend = new Resend(resendApiKey)

        // 4. Parse Body
        const { id, email, firstName } = JSON.parse(event.body)

        if (!id || !email) {
            return { statusCode: 400, headers, body: JSON.stringify({ error: 'Missing ID or Email' }) }
        }

        // 5. Generate Invite Link (Supabase Auth)
        let inviteLink = `${siteUrl}/signin` // Default fallback

        const { data: linkData, error: linkError } = await supabase.auth.admin.generateLink({
            type: 'invite',
            email: email,
            options: {
                redirectTo: `${siteUrl}/onboarding`
            }
        })

        if (!linkError && linkData && linkData.properties) {
            inviteLink = linkData.properties.action_link
            console.log('Generated Invite Link:', inviteLink)
        } else {
            // Error handling & Fallback to Magic Link
            console.error('Generate Link Error Details:', {
                code: linkError?.code,
                message: linkError?.message,
                status: linkError?.status,
                email: email
            })

            // If user exists or other error, try magic link as fallback
            console.log('Attempting Magic Link fallback...')
            const { data: magicData, error: magicError } = await supabase.auth.admin.generateLink({
                type: 'magiclink',
                email: email,
                options: {
                    redirectTo: `${siteUrl}/onboarding`
                }
            })

            if (!magicError && magicData && magicData.properties) {
                inviteLink = magicData.properties.action_link
                console.log('Using Magic Link instead:', inviteLink)
            } else {
                console.error('Magic link also failed:', JSON.stringify(magicError))
                console.log('Using generic signin link as final fallback.')
                // inviteLink remains as /signin
            }
        }

        // 6. Update Database (waitlist_entries)
        // We do this REGARDLESS of link generation success/failure
        // to ensure the user is approved and receives the email.
        const { data, error } = await supabase
            .from('waitlist_entries')
            .update({
                status: 'approved',
                invited_at: new Date().toISOString()
            })
            .eq('id', id)
            .select()

        if (error) {
            console.error('Database Update Error:', error)
            throw error // If DB fails, we probably should stop? Or still send email? 
            // Better to throw so we know approval didn't persist.
        }

        // 7. Send Email (Resend)
        try {
            const { data: emailData, error: emailError } = await resend.emails.send({
                from: 'Opeari <breada@opeari.com>',
                to: [email],
                subject: 'You\'re in üéâ Your Opeari access is ready',
                html: `
                <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; background-color: #ffffff; color: #1a4731;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #2D5A3D 0%, #4A7C59 100%); padding: 40px 20px; text-align: center; border-radius: 12px 12px 0 0;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üéâ</div>
                        <h1 style="color: #ffffff; margin: 0; font-size: 32px; font-weight: 700;">You're In!</h1>
                        <p style="color: #e6f4ea; font-size: 18px; margin-top: 10px; font-weight: 500;">Welcome to the Opeari community</p>
                    </div>

                    <!-- Exclusivity Line -->
                    <div style="background-color: #f0faf4; padding: 15px 20px; text-align: center; border-bottom: 1px solid #e1f0e5;">
                        <p style="margin: 0; font-size: 14px; color: #2D5A3D; font-weight: 500;">
                            You're one of the first families invited to help shape a more human way to find childcare.
                        </p>
                    </div>

                    <div style="padding: 40px 30px;">
                        <!-- Greeting + Body -->
                        <p style="font-size: 16px; line-height: 1.6; color: #333333;">Hey ${firstName || 'Neighbor'},</p>
                        
                        <p style="font-size: 16px; line-height: 1.6; color: #333333;">Big news ‚Äî you've been approved to join Opeari.</p>
                        
                        <p style="font-size: 16px; line-height: 1.6; color: #333333;">We're building a trusted, early-access community of families who support each other with childcare ‚Äî not agencies, not strangers, but real people building real villages. We're so glad you're here.</p>

                        <!-- CTA Button -->
                        <div style="text-align: center; margin: 40px 0;">
                            <a href="${inviteLink}" 
                               style="background-color: #4A7C59; color: #ffffff; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px; display: inline-block; box-shadow: 0 4px 6px rgba(45, 90, 61, 0.2);">
                               Create My Opeari Account
                            </a>
                            <p style="font-size: 13px; color: #888888; margin-top: 12px;">This takes about 3 minutes.</p>
                        </div>

                        <!-- What Happens Next -->
                        <div style="background-color: #f7fbf8; border-left: 4px solid #4A7C59; padding: 25px; border-radius: 0 8px 8px 0; margin-bottom: 30px;">
                            <h3 style="margin-top: 0; color: #2D5A3D; font-size: 18px;">Here's what you'll unlock:</h3>
                            <ul style="padding-left: 20px; margin-bottom: 0; color: #444444;">
                                <li style="margin-bottom: 10px;">Secure your account and set your preferences</li>
                                <li style="margin-bottom: 10px;">Complete your family profile (at your own pace)</li>
                                <li style="margin-bottom: 10px;">Get matched with families nearby</li>
                                <li style="margin-bottom: 0;">Start building your childcare village ‚Äî together üè°</li>
                            </ul>
                        </div>

                        <!-- Trust + Urgency -->
                        <p style="font-size: 14px; color: #666666; font-style: italic; border-top: 1px solid #eeeeee; padding-top: 20px;">
                            This link expires in 24 hours to keep access secure.<br>
                            Link expired? <a href="https://opeari.com/request-link" style="color: #4A7C59;">Get a new one here</a>.<br>
                            Questions? Just reply to this email ‚Äî we're real people.
                        </p>

                        <!-- Footer -->
                        <div style="margin-top: 40px; font-size: 16px; color: #333333;">
                            <p>üçê Welcome to the village!</p>
                            <p style="font-weight: 500; color: #2D5A3D;">The Opeari Team</p>
                        </div>
                        
                        <div style="margin-top: 30px; border-top: 1px solid #eeeeee; padding-top: 20px; text-align: center;">
                            <p style="font-size: 12px; color: #999999; margin: 0;">
                                We open access in waves to protect trust and build strong local communities.
                            </p>
                        </div>
                    </div>
                </div>
                `
            });

            if (emailError) {
                console.error('Resend Error:', emailError)
                return {
                    statusCode: 200,
                    headers,
                    body: JSON.stringify({ ok: true, data, emailSent: false, emailError })
                }
            }

            console.log('Invite Email sent to:', email)
        } catch (mailErr) {
            console.error('Email Exception:', mailErr)
        }

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ ok: true, data, emailSent: true })
        }

    } catch (err) {
        console.error('Admin Approve Error:', err)
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: err.message })
        }
    }
}
