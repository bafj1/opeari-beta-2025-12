<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Setup - Opeari</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mint: #e8f5e9;
            --peach: #ffccc7;
            --dark-green: #1e6b4e;
            --yellow-highlight: #fff7d6;
            --white: #ffffff;
            --light-gray: #F8F9FA;
            --teal: #20b2aa;
            
            /* Derived colors for better UX */
            --peach-light: #fff5f4;
            --peach-dark: #ff9a94;
            --mint-dark: #d4edda;
            --mint-light: #f0f9f0;
            
            /* Header/Footer colors */
            --header-bg: var(--mint-light);
            --footer-bg: var(--mint);
        }

        [data-theme="dark"] {
            --mint: #2d4a32;
            --peach: #d4635a;
            --dark-green: #4a9d6b;
            --yellow-highlight: #8b7d47;
            --white: #1a1a1a;
            --light-gray: #2a2a2a;
            --teal: #4db6ac;
            
            --peach-light: #3a2a2a;
            --peach-dark: #e67e76;
            --mint-dark: #3a4d3e;
            --mint-light: #1f2f23;
            
            --header-bg: var(--mint-light);
            --footer-bg: var(--mint-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comfortaa', sans-serif;
            background: linear-gradient(135deg, var(--mint) 0%, var(--peach-light) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            color: var(--dark-green);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--teal);
            transition: all 0.3s ease;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--dark-green);
            font-weight: 400;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .nav-links a:hover {
            color: var(--peach-dark);
        }

        .sign-in-btn {
            background: var(--peach);
            color: var(--dark-green);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .sign-in-btn:hover {
            background: var(--peach-dark);
            color: var(--white);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: var(--dark-green);
            color: var(--white);
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            background: var(--teal);
        }

        .theme-icon {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .lang-toggle {
            background: var(--teal);
            color: var(--white);
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lang-toggle:hover {
            background: var(--dark-green);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        /* Verification Message (shows first) */
        .verification-container {
            text-align: center;
            background: var(--white);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--teal);
        }

        .verification-container h2 {
            color: var(--dark-green);
            margin-bottom: 1rem;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .verification-container p {
            color: var(--dark-green);
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .waiting-image {
            width: 120px;
            height: 120px;
            margin: 1.5rem auto;
            object-fit: contain;
        }

        /* Account Setup Form (shows after verification) */
        .account-setup {
            display: none;
            background: var(--white);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--teal);
        }

        .success-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .success-header h1 {
            color: var(--dark-green);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .success-header p {
            color: var(--dark-green);
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .early-access-badge {
            background: var(--yellow-highlight);
            color: var(--dark-green);
            padding: 0.3rem 1rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-top: 1rem;
        }

        .badge-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--mint-dark);
        }

        .section-header h3 {
            color: var(--dark-green);
            font-size: 1.1rem;
        }

        .section-icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: var(--dark-green);
            font-weight: 500;
        }

        .required {
            color: var(--peach-dark);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--mint-dark);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
            background: var(--white);
            color: var(--dark-green);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--teal);
        }

        .form-group input:readonly {
            background: var(--mint-light);
            opacity: 0.7;
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--dark-green);
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            background: var(--mint-light);
        }

        .toggle-icon {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .email-note {
            font-size: 0.85rem;
            color: var(--dark-green);
            margin-top: 0.3rem;
            opacity: 0.7;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-top: 0.2rem;
        }

        .checkbox-group label {
            font-size: 0.9rem;
            color: var(--dark-green);
            line-height: 1.4;
            opacity: 0.8;
        }

        .checkbox-group a {
            color: var(--teal);
            text-decoration: none;
        }

        .checkbox-group a:hover {
            text-decoration: underline;
        }

        .submit-btn {
            width: 100%;
            background: var(--peach);
            color: var(--dark-green);
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .submit-btn:hover {
            background: var(--peach-dark);
            color: var(--white);
        }

        .submit-btn:disabled {
            background: var(--light-gray);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .back-link {
            text-align: center;
            margin-top: 1rem;
        }

        .back-link a {
            color: var(--teal);
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .back-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        /* Footer */
        .footer {
            background: var(--footer-bg);
            padding: 2rem;
            text-align: center;
            border-top: 2px solid var(--teal);
            transition: all 0.3s ease;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--dark-green);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--teal);
            text-decoration: underline;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .social-links a {
            color: var(--dark-green);
            font-size: 1.2rem;
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .social-links a:hover {
            background: var(--teal);
            color: var(--white);
        }

        .social-icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .copyright {
            color: var(--dark-green);
            font-size: 0.8rem;
            margin-top: 1rem;
            opacity: 0.7;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .alert.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .alert-icon {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }

        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--mint);
            border-top: 2px solid var(--dark-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
            }

            .footer-links {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <img src="images/logo.png" alt="Opeari Logo" class="logo-img">
        </div>
        <div class="nav-links">
            <a href="#how-it-works">How It Works</a>
            <a href="#safety">Safety</a>
            <a href="#about">About</a>
            <a href="#contact">Contact</a>
            <a href="/login" class="sign-in-btn">Sign In</a>
        </div>
        <div class="controls">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <svg class="theme-icon theme-icon-light" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg class="theme-icon theme-icon-dark" style="display: none;" viewBox="0 0 24 24">
                    <path d="m21 12.79a9 9 0 1 1-6.21-8.58 5.5 5.5 0 0 0 6.21 8.58z"/>
                </svg>
            </button>
            <button class="lang-toggle">ES</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Verification Message (shows first) -->
        <div id="verificationMessage" class="verification-container">
            <h2>Welcome to Opeari!</h2>
            <img src="images/opeari-wait2.png" alt="Opeari mascot waiting" class="waiting-image">
            <p>Verifying your invite link...</p>
            <div class="spinner" style="margin: 1rem auto;"></div>
        </div>

        <!-- Account Setup Form (shows after verification) -->
        <div id="accountSetup" class="account-setup">
            <div class="success-header">
                <h1>You're In!</h1>
                <p>Let's complete your account setup</p>
                <div class="early-access-badge">
                    <svg class="badge-icon" viewBox="0 0 24 24">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                    </svg>
                    Early Access
                </div>
            </div>

            <form id="setupForm">
                <!-- Personal Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <svg class="section-icon" viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <h3>Personal Information</h3>
                    </div>
                    
                    <div class="form-group">
                        <label for="firstName">First Name <span class="required">*</span></label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName">Last Name <span class="required">*</span></label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" readonly>
                        <div class="email-note">This email was verified from your invitation</div>
                    </div>
                </div>

                <!-- Password Section -->
                <div class="form-section">
                    <div class="section-header">
                        <svg class="section-icon" viewBox="0 0 24 24">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <circle cx="12" cy="16" r="1"/>
                            <path d="m7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        <h3>Create Your Password</h3>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Choose a Password <span class="required">*</span></label>
                        <div class="password-input-wrapper">
                            <input type="password" id="password" name="password" placeholder="At least 8 characters" required minlength="8">
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <svg class="toggle-icon" viewBox="0 0 24 24">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
                        <div class="password-input-wrapper">
                            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Re-enter your password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                <svg class="toggle-icon" viewBox="0 0 24 24">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Terms Agreement -->
                <div class="checkbox-group">
                    <input type="checkbox" id="agreeToTerms" name="agreeToTerms" required>
                    <label for="agreeToTerms">
                        I agree to Opeari's <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a>
                    </label>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="submit-btn">Complete Setup & Join Opeari</button>
            </form>

            <div class="back-link">
                <a href="/login">
                    <svg class="back-icon" viewBox="0 0 24 24">
                        <path d="m12 19-7-7 7-7"/>
                        <path d="M19 12H5"/>
                    </svg>
                    Back to Login
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-links">
            <a href="/privacy">Privacy Policy</a>
            <a href="/terms">Terms of Service</a>
            <a href="/safety">Safety</a>
            <a href="/help">Help Center</a>
            <a href="/careers">Careers</a>
            <a href="/contact">Contact</a>
        </div>
        
        <div class="social-links">
            <a href="#" aria-label="Instagram">
                <svg class="social-icon" viewBox="0 0 24 24">
                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
                    <path d="m16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
                    <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
                </svg>
            </a>
            <a href="#" aria-label="Facebook">
                <svg class="social-icon" viewBox="0 0 24 24">
                    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                </svg>
            </a>
            <a href="#" aria-label="Twitter">
                <svg class="social-icon" viewBox="0 0 24 24">
                    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
                </svg>
            </a>
            <a href="#" aria-label="LinkedIn">
                <svg class="social-icon" viewBox="0 0 24 24">
                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
                    <rect x="2" y="9" width="4" height="12"/>
                    <circle cx="4" cy="4" r="2"/>
                </svg>
            </a>
        </div>
        
        <div class="copyright">
            ¬© 2025 Opeari. Making childcare accessible, one connection at a time.
        </div>
    </div>

    <script>
        // Get token and email from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const email = urlParams.get('email');

        // DOM elements
        const verificationMessage = document.getElementById('verificationMessage');
        const accountSetup = document.getElementById('accountSetup');
        const setupForm = document.getElementById('setupForm');

        // Theme toggle functionality
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme icon
            const lightIcon = document.querySelector('.theme-icon-light');
            const darkIcon = document.querySelector('.theme-icon-dark');
            
            if (newTheme === 'dark') {
                lightIcon.style.display = 'none';
                darkIcon.style.display = 'inline';
            } else {
                lightIcon.style.display = 'inline';
                darkIcon.style.display = 'none';
            }
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const lightIcon = document.querySelector('.theme-icon-light');
            const darkIcon = document.querySelector('.theme-icon-dark');
            
            if (savedTheme === 'dark') {
                lightIcon.style.display = 'none';
                darkIcon.style.display = 'inline';
            }
        }

        // Show alert message
        function showAlert(type, message, options = {}) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            
            // Create icon element
            const iconSVG = type === 'error' 
                ? '<svg class="alert-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
                : '<svg class="alert-icon" viewBox="0 0 24 24"><path d="m9 12 2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>';
            
            alert.innerHTML = `${iconSVG} ${message}`;
            
            // Add request new link button if expired
            if (options.showRequestButton) {
                const buttonHTML = `
                    <div style="margin-top: 15px;">
                        <button onclick="requestNewInvite()" class="request-new-btn" style="
                            background: #20b2aa; 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-size: 14px;
                            font-family: inherit;
                        ">
                            Request New Invite Link
                        </button>
                    </div>
                `;
                alert.innerHTML += buttonHTML;
            }
            
            const container = accountSetup.style.display !== 'none' ? accountSetup : verificationMessage;
            container.insertBefore(alert, container.firstChild);

            // Auto-remove alert after longer time if not expired
            if (!options.showRequestButton) {
                setTimeout(() => {
                    if (alert && alert.parentNode) {
                        alert.remove();
                    }
                }, 8000);
            }
        }

        // Disable/enable form based on token validity
        function setFormState(enabled, reason = '') {
            const form = document.getElementById('setupForm');
            const submitBtn = form.querySelector('.submit-btn');
            const inputs = form.querySelectorAll('input, button');
            
            inputs.forEach(input => {
                if (input.type !== 'email') { // Keep email readonly but visible
                    input.disabled = !enabled;
                }
            });
            
            if (!enabled) {
                submitBtn.innerHTML = `<svg class="toggle-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><circle cx="12" cy="16" r="1"/><path d="m7 11V7a5 5 0 0 1 10 0v4"/></svg> ${reason || 'Form Disabled'}`;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
            } else {
                submitBtn.innerHTML = `Complete Setup & Join Opeari`;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
            }
        }

        // Request new invite functionality
        async function requestNewInvite() {
            if (!email) {
                showAlert('error', 'No email found. Please check your original invite link.');
                return;
            }

            const button = document.querySelector('.request-new-btn');
            if (!button) {
                console.error('Request button not found');
                return;
            }
            
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'Requesting...';

            try {
                const response = await fetch('/.netlify/functions/resendInvite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    const remainingText = data.requestsRemaining !== undefined 
                        ? ` (${data.requestsRemaining} requests remaining)`
                        : '';
                    
                    showAlert('success', `New invite sent to ${email}!${remainingText} Check your email and click the new link.`);
                    
                    // Remove the request button since they got a new link
                    if (button.parentNode) {
                        button.parentNode.remove();
                    }
                } else if (response.status === 429) {
                    showAlert('error', data.error || 'Too many requests. Please contact support.');
                    button.disabled = false;
                    button.innerHTML = originalText;
                } else {
                    showAlert('error', data.error || 'Failed to send new invite. Please try again.');
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error requesting new invite:', error);
                showAlert('error', 'Network error. Please check your connection and try again.');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            const icon = button.querySelector('.toggle-icon');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.innerHTML = '<path d="m9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="m10.73 5.08a10.43 10.43 0 0 1 1.27-.08c7 0 11 8 11 8a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 1 12s4 8 11 8a9.74 9.74 0 0 0 5-1.17"/><line x1="2" y1="2" x2="22" y2="22"/>';
            } else {
                field.type = 'password';
                icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
            }
        }

        // Verify invite token
        async function verifyInviteToken(token) {
            console.log('üîç Starting token verification for:', token?.substring(0, 8) + '...');
            
            try {
                console.log('üìß Email from URL:', email);
                
                const requestBody = { token };
                if (email) {
                    requestBody.email = email;
                }
                
                console.log('üì§ Sending verification request to verify-invite...');
                const response = await fetch('/.netlify/functions/verify-invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì• Response status:', response.status);
                
                let data;
                try {
                    data = await response.json();
                    console.log('üìã Response data:', data);
                } catch (parseError) {
                    console.error('‚ùå Failed to parse response as JSON:', parseError);
                    throw new Error('Server returned invalid response');
                }

                if (response.ok && data.success && data.valid) {
                    console.log('‚úÖ Token verification successful');
                    verificationMessage.style.display = 'none';
                    accountSetup.style.display = 'block';
                    setFormState(true);
                    
                    if (email || data.email) {
                        document.getElementById('email').value = email || data.email;
                    }
                    if (data.name) {
                        document.getElementById('firstName').value = data.name;
                    }
                } else if (response.ok && data.expired === true) {
                    console.log('‚è∞ Token expired, but response was OK - showing resend option');
                    verificationMessage.style.display = 'none';
                    accountSetup.style.display = 'block';
                    setFormState(false, 'Link Expired');
                    
                    if (data.email || email) {
                        document.getElementById('email').value = data.email || email;
                    }
                    
                    showAlert('error', 'Your invite link has expired. Request a new one below:', { showRequestButton: true });
                } else if (!response.ok) {
                    if (response.status === 400) {
                        setFormState(false, 'Link Issue');
                        showAlert('error', 'Your invite link has an issue (expired, invalid, or already used). Request a new one below:', { showRequestButton: true });
                    } else if (response.status === 404) {
                        setFormState(false, 'Not Found');
                        showAlert('error', 'No invitation found for this link. Request a new invite below:', { showRequestButton: true });
                    } else if (response.status === 500) {
                        setFormState(false, 'Server Error');
                        showAlert('error', 'Server error occurred. Request a new invite below:', { showRequestButton: true });
                    } else {
                        setFormState(false, 'Error');
                        showAlert('error', `Server error (${response.status}). Request a new invite below:`, { showRequestButton: true });
                    }
                } else {
                    console.log('‚ùå Token verification failed:', data);
                    
                    const isExpiredToken = data?.expired === true;
                    
                    if (isExpiredToken) {
                        setFormState(false, 'Link Expired');
                        showAlert('error', 'Your invite link has expired. Request a new one below:', { showRequestButton: true });
                    } else {
                        setFormState(false, 'Invalid Link');
                        if (data && data.error) {
                            showAlert('error', data.error + ' Request a new invite below:', { showRequestButton: true });
                        } else {
                            showAlert('error', 'Your invite link is invalid. Request a new one below:', { showRequestButton: true });
                        }
                    }
                    
                    if (email) {
                        document.getElementById('email').value = email;
                    }
                }
            } catch (error) {
                console.error('‚ùå Token verification error:', error);
                
                verificationMessage.style.display = 'none';
                accountSetup.style.display = 'block';
                setFormState(false, 'Connection Error');
                
                if (email) {
                    document.getElementById('email').value = email;
                }
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showAlert('error', 'Unable to connect to our servers. Request a new invite link below:', { showRequestButton: true });
                } else if (error.message.includes('invalid response')) {
                    showAlert('error', 'Server is experiencing issues. Request a new invite link below:', { showRequestButton: true });
                } else {
                    showAlert('error', 'Unable to verify your invite link. This may be expired or invalid. Request a new link below:', { showRequestButton: true });
                }
            }
        }

        // Handle form submission
        setupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(setupForm);
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            const firstName = formData.get('firstName');
            const lastName = formData.get('lastName');
            
            // Validation
            if (!firstName || !lastName) {
                showAlert('error', 'Please fill in your first and last name.');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('error', 'Passwords do not match.');
                return;
            }
            
            if (password.length < 8) {
                showAlert('error', 'Password must be at least 8 characters long.');
                return;
            }
            
            const submitBtn = setupForm.querySelector('.submit-btn');
            const originalHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div> Creating Account...';
            
            try {
                console.log('üöÄ Submitting to finalizeAccount...');
                
                const response = await fetch('/.netlify/functions/finalizeAccount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        token: token,
                        password: password,
                        firstName: firstName,
                        lastName: lastName
                    })
                });
                
                const data = await response.json();
                console.log('üìã finalizeAccount response:', data);
                
                if (response.ok && data.success) {
                    console.log('‚úÖ Account creation successful!');
                    showAlert('success', 'Account created successfully! Redirecting to login...');
                    
                    setTimeout(() => {
                        setupForm.innerHTML = `
                            <div style="text-align: center; padding: 2rem;">
                                <h2 style="color: var(--dark-green); margin-bottom: 1rem;">
                                    <svg style="width: 30px; height: 30px; stroke: currentColor; fill: none; stroke-width: 2; margin-right: 0.5rem;" viewBox="0 0 24 24">
                                        <path d="m9 12 2 2 4-4"/>
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                    Welcome to Opeari! üçê
                                </h2>
                                <p style="margin-bottom: 2rem;">Your account has been created successfully.</p>
                                <a href="/login" style="
                                    background: var(--peach); 
                                    color: var(--dark-green); 
                                    padding: 12px 24px; 
                                    border-radius: 8px; 
                                    text-decoration: none; 
                                    font-weight: 600;
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                ">
                                    Go to Login
                                </a>
                            </div>
                        `;
                    }, 2000);
                    
                } else {
                    console.log('‚ùå Account creation failed:', data);
                    showAlert('error', data.error || 'Failed to create account. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error creating account:', error);
                showAlert('error', 'Network error. Please check your connection and try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Page loaded, initializing...');
            console.log('üìß Email from URL:', email);
            console.log('üé´ Token from URL:', token ? token.substring(0, 8) + '...' : 'missing');
            
            initTheme();
            
            if (email) {
                document.getElementById('email').value = email;
            }
            
            if (token) {
                verificationMessage.style.display = 'block';
                accountSetup.style.display = 'none';
                verifyInviteToken(token);
            } else {
                verificationMessage.style.display = 'none';
                accountSetup.style.display = 'block';
                setFormState(false, 'No Token');
                showAlert('error', 'No invite token found in URL. Please check your invite link.');
            }
        });

        // Make functions global
        window.togglePassword = togglePassword;
        window.toggleTheme = toggleTheme;
        window.requestNewInvite = requestNewInvite;
    </script>
</body>
</html>
