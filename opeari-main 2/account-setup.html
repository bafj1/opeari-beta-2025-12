<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set Up Your Account | Opeari</title>
  <meta name="description" content="Complete your Opeari account setup and start connecting with your childcare village." />
  <link rel="icon" href="images/favicon.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #1e6b4e;
      --primary-dark: #15503a;
      --coral: #F8C3B3;
      --coral-light: rgba(248, 195, 179, 0.3);
      --background: #fffaf5;
      --background-mint: #e8f5f0;
      --text: #1e6b4e;
      --text-light: #5a8a72;
      --text-muted: #8fb89f;
      --white: #ffffff;
      --border: #c8e6d9;
      --border-light: #e0f0e8;
      --error: #dc2626;
      --error-bg: #fef2f2;
      --error-border: #fecaca;
      --success: #16a34a;
      --success-bg: #f0fdf4;
      --success-border: #bbf7d0;
    }
    
    body {
      font-family: 'Comfortaa', sans-serif;
      background: var(--background);
      min-height: 100vh;
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    
    /* Header - matches index.html */
    header {
      background: var(--white);
      padding: 0 2rem;
      border-bottom: 1px solid var(--border-light);
      height: 80px;
      display: flex;
      align-items: center;
    }
    
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      justify-content: center;
    }
    
    .logo {
      height: 80px;
      width: auto;
    }
    
    /* Main Content */
    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .setup-card {
      background: var(--white);
      border-radius: 20px;
      padding: 2rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(30, 107, 78, 0.08);
    }
    
    /* Welcome Header */
    .welcome-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .welcome-image {
      width: 120px;
      height: auto;
      margin: 0 auto 1rem;
    }
    
    .welcome-header h1 {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    
    .welcome-header p {
      color: var(--text-light);
      font-size: 0.95rem;
      line-height: 1.5;
    }
    
    .user-name {
      color: var(--primary);
      font-weight: 700;
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    label {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--primary);
      margin-bottom: 0.4rem;
    }
    
    input {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-family: 'Comfortaa', sans-serif;
      font-size: 0.95rem;
      color: var(--text);
      transition: all 0.2s ease;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 107, 78, 0.1);
    }
    
    input::placeholder {
      color: var(--text-muted);
    }
    
    .password-requirements {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .password-requirements p {
      margin-bottom: 0.25rem;
    }
    
    .password-requirements ul {
      padding-left: 1.25rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.15rem;
    }
    
    .password-requirements li {
      transition: color 0.2s ease;
    }
    
    .password-requirements li.valid {
      color: var(--success);
    }
    
    /* Password Toggle */
    .password-wrapper {
      position: relative;
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px;
    }
    
    .password-toggle:hover {
      color: var(--primary);
    }
    
    .password-toggle svg {
      width: 20px;
      height: 20px;
    }
    
    /* Button */
    .btn-primary {
      width: 100%;
      padding: 1rem;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 50px;
      font-family: 'Comfortaa', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 0.5rem;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn-primary:disabled {
      background: var(--border);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary.loading {
      position: relative;
      color: transparent;
    }
    
    .btn-primary.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 3px solid var(--white);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      left: 50%;
      top: 50%;
      margin-left: -10px;
      margin-top: -10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Messages */
    .message {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      display: none;
    }
    
    .message.error {
      background: var(--error-bg);
      border: 1px solid var(--error-border);
      color: var(--error);
      display: block;
    }
    
    .message.success {
      background: var(--success-bg);
      border: 1px solid var(--success-border);
      color: var(--success);
      display: block;
    }
    
    /* Loading State */
    .loading-content {
      text-align: center;
      padding: 3rem 1rem;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    .loading-content p {
      color: var(--text-light);
    }
    
    /* States */
    .state {
      display: none;
    }
    
    .state.active {
      display: block;
    }
    
    /* Footer note */
    .footer-note {
      text-align: center;
      margin-top: 1.25rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    .footer-note a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }
    
    /* Confetti Canvas */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    
    /* Responsive */
    @media (max-width: 520px) {
      header {
        height: 70px;
      }
      
      .logo {
        height: 60px;
      }
      
      main {
        padding: 1rem;
      }
      
      .setup-card {
        padding: 1.5rem;
      }
      
      .welcome-header h1 {
        font-size: 1.35rem;
      }
      
      .password-requirements ul {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a href="index.html">
        <img src="images/offiical opeari logo (5.6.25).svg" alt="Opeari" class="logo" />
      </a>
    </div>
  </header>
  
  <main>
    <div class="setup-card">
      
      <!-- Loading State -->
      <div id="loadingState" class="state active">
        <div class="loading-content">
          <div class="spinner"></div>
          <p>Setting up your account...</p>
        </div>
      </div>
      
      <!-- Error State -->
      <div id="errorState" class="state">
        <div class="welcome-header">
          <img src="images/pear-welcome.png" alt="Opeari" class="welcome-image" />
          <h1>Something went wrong</h1>
          <p id="errorMessage">We couldn't verify your invite link. It may have expired.</p>
        </div>
        <a href="waitlist.html" class="btn-primary" style="display: block; text-align: center; text-decoration: none;">
          Return to Waitlist
        </a>
      </div>
      
      <!-- Password Setup State -->
      <div id="setupState" class="state">
        <div class="welcome-header">
          <img src="images/pear-welcome.png" alt="Welcome to Opeari" class="welcome-image" />
          <h1>Welcome to Opeari!</h1>
          <p>Hey <span id="userName" class="user-name">there</span>! Let's finish setting up your account.</p>
        </div>
        
        <div id="setupMessage" class="message"></div>
        
        <form id="setupForm" autocomplete="off">
          <div class="form-group">
            <label for="password">Create a password</label>
            <div class="password-wrapper">
              <input 
                type="password" 
                id="password" 
                name="new-password" 
                placeholder="Choose a secure password"
                required
                minlength="8"
                autocomplete="new-password"
              />
              <button type="button" class="password-toggle" id="togglePassword" aria-label="Show password">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
            <div class="password-requirements">
              <p>Password must have:</p>
              <ul>
                <li id="req-length">At least 8 characters</li>
                <li id="req-upper">One uppercase letter</li>
                <li id="req-lower">One lowercase letter</li>
                <li id="req-number">One number</li>
              </ul>
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirm password</label>
            <div class="password-wrapper">
              <input 
                type="password" 
                id="confirmPassword" 
                name="confirm-password" 
                placeholder="Type your password again"
                required
                autocomplete="new-password"
              />
              <button type="button" class="password-toggle" id="toggleConfirm" aria-label="Show password">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
          </div>
          
          <button type="submit" id="submitBtn" class="btn-primary" disabled>
            Create My Account
          </button>
        </form>
        
        <p class="footer-note">
          Already have an account? <a href="login.html">Sign in</a>
        </p>
      </div>
      
      <!-- Success State -->
      <div id="successState" class="state">
        <canvas id="confetti-canvas"></canvas>
        <div class="welcome-header">
          <img src="images/pear-welcome.png" alt="Success!" class="welcome-image" />
          <h1>You're all set!</h1>
          <p>Your account is ready. Let's complete your profile so we can find your perfect matches.</p>
        </div>
        
        <a href="onboarding.html" class="btn-primary" style="display: block; text-align: center; text-decoration: none;">
          Complete My Profile
        </a>
      </div>
      
    </div>
  </main>

  <script>
    (function() {
      // ============ CONFIG ============
      const SUPABASE_URL = 'https://rvostbkbbddbgcnxqchv.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2b3N0YmtiYmRkYmdjbnhxY2h2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzcwMjAsImV4cCI6MjA4MDQ1MzAyMH0.k8LLGt_nCsFO9xINa-80Y49NSPSxryYxCoACwk97E_w';
      
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // ============ SECURITY: Rate limiting ============
      const MAX_ATTEMPTS = 5;
      const LOCKOUT_TIME = 15 * 60 * 1000; // 15 minutes
      let attempts = parseInt(sessionStorage.getItem('setup_attempts') || '0');
      let lockoutUntil = parseInt(sessionStorage.getItem('setup_lockout') || '0');
      
      function checkRateLimit() {
        if (Date.now() < lockoutUntil) {
          const minutesLeft = Math.ceil((lockoutUntil - Date.now()) / 60000);
          throw new Error(`Too many attempts. Please try again in ${minutesLeft} minutes.`);
        }
        if (Date.now() > lockoutUntil) {
          // Reset after lockout period
          attempts = 0;
          sessionStorage.removeItem('setup_lockout');
        }
      }
      
      function recordAttempt() {
        attempts++;
        sessionStorage.setItem('setup_attempts', attempts.toString());
        if (attempts >= MAX_ATTEMPTS) {
          lockoutUntil = Date.now() + LOCKOUT_TIME;
          sessionStorage.setItem('setup_lockout', lockoutUntil.toString());
        }
      }
      
      function resetAttempts() {
        attempts = 0;
        sessionStorage.removeItem('setup_attempts');
        sessionStorage.removeItem('setup_lockout');
      }
      
      // ============ DOM ELEMENTS ============
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const setupState = document.getElementById('setupState');
      const successState = document.getElementById('successState');
      const errorMessage = document.getElementById('errorMessage');
      const userName = document.getElementById('userName');
      const setupMessage = document.getElementById('setupMessage');
      const setupForm = document.getElementById('setupForm');
      const submitBtn = document.getElementById('submitBtn');
      const passwordInput = document.getElementById('password');
      const confirmInput = document.getElementById('confirmPassword');
      
      // Password requirement elements
      const reqLength = document.getElementById('req-length');
      const reqUpper = document.getElementById('req-upper');
      const reqLower = document.getElementById('req-lower');
      const reqNumber = document.getElementById('req-number');
      
      // ============ UTILITIES ============
      
      // Sanitize input
      function sanitize(str) {
        if (!str) return '';
        return str.replace(/[<>\"\'&]/g, '').trim();
      }
      
      // Show a specific state
      function showState(state) {
        [loadingState, errorState, setupState, successState].forEach(s => s.classList.remove('active'));
        state.classList.add('active');
      }
      
      // Show error message
      function showError(msg) {
        setupMessage.textContent = msg;
        setupMessage.className = 'message error';
      }
      
      // ============ PASSWORD VALIDATION ============
      function validatePassword(password) {
        const checks = {
          length: password.length >= 8,
          upper: /[A-Z]/.test(password),
          lower: /[a-z]/.test(password),
          number: /[0-9]/.test(password)
        };
        
        reqLength.classList.toggle('valid', checks.length);
        reqUpper.classList.toggle('valid', checks.upper);
        reqLower.classList.toggle('valid', checks.lower);
        reqNumber.classList.toggle('valid', checks.number);
        
        return Object.values(checks).every(Boolean);
      }
      
      function checkFormValidity() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        const isValid = validatePassword(password) && password === confirm && confirm.length > 0;
        submitBtn.disabled = !isValid;
      }
      
      // ============ PASSWORD TOGGLE ============
      function setupPasswordToggles() {
        document.getElementById('togglePassword').addEventListener('click', () => {
          const type = passwordInput.type === 'password' ? 'text' : 'password';
          passwordInput.type = type;
        });
        
        document.getElementById('toggleConfirm').addEventListener('click', () => {
          const type = confirmInput.type === 'password' ? 'text' : 'password';
          confirmInput.type = type;
        });
      }
      
      // ============ CONFETTI ============
      function launchConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const colors = ['#1e6b4e', '#F8C3B3', '#3ca370', '#d8f5e5', '#5a8a72'];
        const confettiCount = 150;
        const confetti = [];
        
        for (let i = 0; i < confettiCount; i++) {
          confetti.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            w: Math.random() * 10 + 5,
            h: Math.random() * 6 + 4,
            color: colors[Math.floor(Math.random() * colors.length)],
            speed: Math.random() * 3 + 2,
            angle: Math.random() * 360,
            spin: Math.random() * 0.2 - 0.1
          });
        }
        
        let frame = 0;
        const maxFrames = 180;
        
        function animate() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          confetti.forEach(c => {
            c.y += c.speed;
            c.x += Math.sin(c.angle) * 0.5;
            c.angle += c.spin;
            
            ctx.save();
            ctx.translate(c.x + c.w / 2, c.y + c.h / 2);
            ctx.rotate(c.angle);
            ctx.fillStyle = c.color;
            ctx.fillRect(-c.w / 2, -c.h / 2, c.w, c.h);
            ctx.restore();
          });
          
          frame++;
          if (frame < maxFrames) {
            requestAnimationFrame(animate);
          } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
        }
        
        animate();
      }
      
      // ============ INITIALIZATION ============
      async function init() {
        try {
          checkRateLimit();
          
          // Get the hash params (Supabase puts tokens in hash)
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const accessToken = hashParams.get('access_token');
          const refreshToken = hashParams.get('refresh_token');
          const type = hashParams.get('type');
          
          console.log('Auth type:', type);
          
          // If this is an invite/recovery link
          if (type === 'invite' || type === 'recovery' || type === 'signup' || type === 'magiclink') {
            if (accessToken) {
              // Set the session
              const { data, error } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
              });
              
              if (error) throw error;
              
              // Get user info
              const { data: { user } } = await supabase.auth.getUser();
              
              if (user) {
                console.log('User authenticated:', user.email);
                
                // Set user name from metadata (sanitized)
                const firstName = sanitize(user.user_metadata?.first_name) || 'there';
                userName.textContent = firstName;
                
                // Clear the hash from URL (cleaner look, security)
                history.replaceState(null, '', window.location.pathname);
                
                showState(setupState);
              } else {
                throw new Error('Could not get user info');
              }
            } else {
              throw new Error('No access token found');
            }
          } else {
            // Check if user is already logged in
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
              const { data: { user } } = await supabase.auth.getUser();
              
              // Check if member record exists
              const { data: member } = await supabase
                .from('members')
                .select('id, onboarding_complete')
                .eq('user_id', user.id)
                .single();
              
              if (member) {
                // Already set up, redirect appropriately
                if (member.onboarding_complete) {
                  window.location.href = 'dashboard.html';
                } else {
                  window.location.href = 'onboarding.html';
                }
              } else {
                // Need to complete setup
                const firstName = sanitize(user.user_metadata?.first_name) || 'there';
                userName.textContent = firstName;
                showState(setupState);
              }
            } else {
              // No session and no invite token
              errorMessage.textContent = 'This link has expired or is invalid. Please check your email for a new invite.';
              showState(errorState);
            }
          }
        } catch (err) {
          console.error('Init error:', err);
          errorMessage.textContent = err.message || 'Something went wrong. Please try again.';
          showState(errorState);
        }
      }
      
      // ============ FORM SUBMISSION ============
      async function handleSubmit(e) {
        e.preventDefault();
        
        try {
          checkRateLimit();
        } catch (err) {
          showError(err.message);
          return;
        }
        
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        // Validation
        if (password !== confirm) {
          showError('Passwords do not match.');
          recordAttempt();
          return;
        }
        
        if (!validatePassword(password)) {
          showError('Password does not meet requirements.');
          recordAttempt();
          return;
        }
        
        // Show loading
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        
        try {
          // Update user's password
          const { data, error } = await supabase.auth.updateUser({
            password: password
          });
          
          if (error) throw error;
          
          // Get current user
          const { data: { user } } = await supabase.auth.getUser();
          
          if (!user) throw new Error('Could not get user info');
          
          // Check if member record already exists
          const { data: existingMember } = await supabase
            .from('members')
            .select('id')
            .eq('user_id', user.id)
            .single();
          
          if (!existingMember) {
            // Create member record
            const { error: memberError } = await supabase
              .from('members')
              .insert({
                user_id: user.id,
                email: user.email,
                first_name: sanitize(user.user_metadata?.first_name) || null,
                last_name: sanitize(user.user_metadata?.last_name) || null,
                display_name: sanitize(user.user_metadata?.first_name) || null,
                user_type: user.user_metadata?.user_type || 'family',
                onboarding_complete: false,
                created_at: new Date().toISOString()
              });
            
            if (memberError && !memberError.message.includes('duplicate')) {
              throw memberError;
            }
          }
          
          // Update waitlist record if we have the ID
          if (user.user_metadata?.waitlist_id) {
            await supabase
              .from('waitlist')
              .update({ 
                approved: true,
                approved_at: new Date().toISOString()
              })
              .eq('id', user.user_metadata.waitlist_id);
          }
          
          // Success!
          resetAttempts();
          console.log('Account setup complete!');
          showState(successState);
          launchConfetti();
          
        } catch (err) {
          console.error('Setup error:', err);
          showError(err.message || 'Failed to create account. Please try again.');
          recordAttempt();
          submitBtn.classList.remove('loading');
          submitBtn.disabled = false;
        }
      }
      
      // ============ EVENT LISTENERS ============
      passwordInput.addEventListener('input', checkFormValidity);
      confirmInput.addEventListener('input', checkFormValidity);
      setupForm.addEventListener('submit', handleSubmit);
      setupPasswordToggles();
      
      // ============ START ============
      init();
    })();
  </script>
</body>
</html>
